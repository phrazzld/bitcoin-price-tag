<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Price Tag - CI Health Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: #161b22;
            border-radius: 8px;
            border: 1px solid #30363d;
        }
        
        .header h1 {
            color: #58a6ff;
            margin-bottom: 10px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .metric-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            transition: border-color 0.2s;
        }
        
        .metric-card:hover {
            border-color: #58a6ff;
        }
        
        .metric-title {
            font-size: 14px;
            color: #8b949e;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-value.success { color: #3fb950; }
        .metric-value.warning { color: #f85149; }
        .metric-value.info { color: #58a6ff; }
        
        .metric-subtitle {
            font-size: 12px;
            color: #8b949e;
        }
        
        .recent-runs {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }
        
        .recent-runs h3 {
            margin-bottom: 15px;
            color: #58a6ff;
        }
        
        .run-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #21262d;
        }
        
        .run-item:last-child {
            border-bottom: none;
        }
        
        .run-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-success {
            background: #238636;
            color: white;
        }
        
        .status-failure {
            background: #da3633;
            color: white;
        }
        
        .status-in_progress {
            background: #bf8700;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }
        
        .error {
            background: #21262d;
            border: 1px solid #f85149;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #f85149;
        }
        
        .refresh-button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .refresh-button:hover {
            background: #2ea043;
        }
        
        .last-updated {
            text-align: center;
            color: #8b949e;
            font-size: 12px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Bitcoin Price Tag CI Dashboard</h1>
            <p>Real-time CI/CD pipeline health monitoring</p>
        </div>
        
        <div id="error-container"></div>
        
        <div id="loading" class="loading">
            <p>🔄 Loading CI health data...</p>
        </div>
        
        <div id="dashboard-content" style="display: none;">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">Pipeline Health</div>
                    <div id="health-score" class="metric-value info">--</div>
                    <div class="metric-subtitle">Overall health percentage</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Success Rate (7d)</div>
                    <div id="success-rate" class="metric-value success">--</div>
                    <div class="metric-subtitle">Successful builds percentage</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Avg Duration</div>
                    <div id="avg-duration" class="metric-value info">--</div>
                    <div class="metric-subtitle">Average pipeline time</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Last Failure</div>
                    <div id="last-failure" class="metric-value warning">--</div>
                    <div class="metric-subtitle">Time since last failure</div>
                </div>
            </div>
            
            <div class="recent-runs">
                <h3>📋 Recent Pipeline Runs</h3>
                <div id="recent-runs-list">
                    <!-- Populated by JavaScript -->
                </div>
                
                <button class="refresh-button" onclick="loadDashboardData()">
                    🔄 Refresh Data
                </button>
            </div>
            
            <div class="last-updated">
                Last updated: <span id="last-updated-time">--</span>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Update these values for your repository
        const REPO_OWNER = 'phrazzld';
        const REPO_NAME = 'bitcoin-price-tag';
        const WORKFLOW_NAME = 'CI';
        
        // GitHub API endpoints
        const API_BASE = 'https://api.github.com';
        const WORKFLOWS_URL = `${API_BASE}/repos/${REPO_OWNER}/${REPO_NAME}/actions/workflows`;
        
        async function loadDashboardData() {
            try {
                showLoading(true);
                clearError();
                
                // Get workflow runs
                const workflowId = await getWorkflowId();
                const runs = await getWorkflowRuns(workflowId);
                
                // Calculate metrics
                const metrics = calculateMetrics(runs);
                
                // Update UI
                updateMetrics(metrics);
                updateRecentRuns(runs.slice(0, 10));
                updateLastUpdated();
                
                showLoading(false);
                
            } catch (error) {
                console.error('Dashboard load error:', error);
                showError(`Failed to load CI data: ${error.message}`);
                showLoading(false);
            }
        }
        
        async function getWorkflowId() {
            const response = await fetch(`${WORKFLOWS_URL}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            const workflow = data.workflows.find(w => w.name === WORKFLOW_NAME);
            
            if (!workflow) throw new Error(`Workflow "${WORKFLOW_NAME}" not found`);
            return workflow.id;
        }
        
        async function getWorkflowRuns(workflowId) {
            const response = await fetch(`${WORKFLOWS_URL}/${workflowId}/runs?per_page=50`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            return data.workflow_runs;
        }
        
        function calculateMetrics(runs) {
            const recent = runs.slice(0, 20); // Last 20 runs
            const lastWeek = runs.filter(run => {
                const runDate = new Date(run.created_at);
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                return runDate > weekAgo;
            });
            
            const successfulRuns = recent.filter(run => run.conclusion === 'success');
            const successRate = recent.length > 0 ? (successfulRuns.length / recent.length * 100) : 0;
            
            // Calculate average duration for completed runs
            const completedRuns = recent.filter(run => run.conclusion && run.conclusion !== 'cancelled');
            const avgDuration = completedRuns.length > 0 
                ? completedRuns.reduce((sum, run) => {
                    const duration = new Date(run.updated_at) - new Date(run.created_at);
                    return sum + duration;
                }, 0) / completedRuns.length / 1000
                : 0;
            
            // Find last failure
            const lastFailure = runs.find(run => run.conclusion === 'failure');
            const timeSinceFailure = lastFailure 
                ? Math.floor((Date.now() - new Date(lastFailure.updated_at)) / (1000 * 60 * 60))
                : null;
            
            // Health score based on recent success rate and failure recency
            let healthScore = Math.round(successRate);
            if (timeSinceFailure !== null && timeSinceFailure < 24) {
                healthScore = Math.max(0, healthScore - 20); // Reduce health if recent failure
            }
            
            return {
                healthScore,
                successRate: Math.round(successRate),
                avgDuration: Math.round(avgDuration),
                timeSinceFailure,
                totalRuns: recent.length
            };
        }
        
        function updateMetrics(metrics) {
            document.getElementById('health-score').textContent = `${metrics.healthScore}%`;
            document.getElementById('success-rate').textContent = `${metrics.successRate}%`;
            document.getElementById('avg-duration').textContent = `${metrics.avgDuration}s`;
            
            const lastFailureEl = document.getElementById('last-failure');
            if (metrics.timeSinceFailure !== null) {
                if (metrics.timeSinceFailure < 1) {
                    lastFailureEl.textContent = '< 1h ago';
                } else if (metrics.timeSinceFailure < 24) {
                    lastFailureEl.textContent = `${metrics.timeSinceFailure}h ago`;
                } else {
                    const days = Math.floor(metrics.timeSinceFailure / 24);
                    lastFailureEl.textContent = `${days}d ago`;
                }
            } else {
                lastFailureEl.textContent = 'None recent';
            }
            
            // Update health score color
            const healthEl = document.getElementById('health-score');
            healthEl.className = 'metric-value ' + 
                (metrics.healthScore >= 80 ? 'success' : 
                 metrics.healthScore >= 60 ? 'warning' : 'info');
        }
        
        function updateRecentRuns(runs) {
            const container = document.getElementById('recent-runs-list');
            container.innerHTML = '';
            
            runs.forEach(run => {
                const runEl = document.createElement('div');
                runEl.className = 'run-item';
                
                const duration = run.conclusion 
                    ? Math.round((new Date(run.updated_at) - new Date(run.created_at)) / 1000)
                    : null;
                
                const statusClass = `status-${run.status === 'completed' ? run.conclusion : run.status}`;
                const statusText = run.status === 'completed' ? run.conclusion : run.status;
                
                runEl.innerHTML = `
                    <div>
                        <strong>${run.head_branch}</strong>
                        <div style="font-size: 12px; color: #8b949e;">
                            ${run.head_sha.slice(0, 7)} • ${formatDate(run.created_at)}
                            ${duration ? ` • ${duration}s` : ''}
                        </div>
                    </div>
                    <div>
                        <span class="run-status ${statusClass}">${statusText}</span>
                    </div>
                `;
                
                container.appendChild(runEl);
            });
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffHours < 1) return '< 1h ago';
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
        
        function updateLastUpdated() {
            document.getElementById('last-updated-time').textContent = new Date().toLocaleString();
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('dashboard-content').style.display = show ? 'none' : 'block';
        }
        
        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error">⚠️ ${message}</div>`;
        }
        
        function clearError() {
            document.getElementById('error-container').innerHTML = '';
        }
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadDashboardData);
        
        // Auto-refresh every 5 minutes
        setInterval(loadDashboardData, 5 * 60 * 1000);
    </script>
</body>
</html>