#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Run tests before pushing
pnpm test

# Check branch naming convention
BRANCH_NAME=$(git symbolic-ref --short HEAD)
BRANCH_PATTERN="^(feature|bugfix|hotfix|release|chore|docs|refactor)/[a-z0-9-]+$"

if ! echo "$BRANCH_NAME" | grep -E "$BRANCH_PATTERN" > /dev/null; then
  echo "ERROR: Branch name '$BRANCH_NAME' doesn't follow the naming convention!"
  echo "Branch names should follow pattern: type/description-with-hyphens"
  echo "Valid types: feature, bugfix, hotfix, release, chore, docs, refactor"
  echo "Example: feature/add-bitcoin-price-display"
  
  # Don't block pushes on the main branch or manifest-v3-migration branch (current active branch)
  if [ "$BRANCH_NAME" = "master" ] || [ "$BRANCH_NAME" = "main" ] || [ "$BRANCH_NAME" = "manifest-v3-migration" ]; then
    echo "Pushing to $BRANCH_NAME, allowing push despite naming violation."
    exit 0
  fi
  
  exit 1
fi